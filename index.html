<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××œ×™×“×•×¡ - ×’×¨×¡×” 6.2</title>
    <link rel="icon" href="fire-icon.svg" type="image/png">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --board-red: #d32f2f;
            --board-dark-red: #b71c1c;
            --step-bg: #ffffff;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --btn-blue: #1976d2;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            font-family: var(--font-main);
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ××¡×š ×¤×ª×™×—×”
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #setup-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.4s;
        }
        .setup-card {
            background: white; padding: 2rem 2.5rem;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center; width: 90%; max-width: 420px;
            border: 1px solid #eee;
        }
        .setup-card h1 { color: var(--board-red); margin: 0 0 4px; font-size: 2.4rem; }
        .setup-card .subtitle { color: #888; font-size: 0.9rem; margin-bottom: 18px; }

        /* --- Toggle ××¦×‘ --- */
        .mode-toggle {
            display: flex; background: #f0f0f0; border-radius: 50px;
            padding: 4px; margin-bottom: 20px; gap: 2px;
        }
        .mode-toggle button {
            flex: 1; padding: 9px 0; font-size: 1rem; font-weight: 600;
            border: none; border-radius: 50px; cursor: pointer;
            background: transparent; color: #888;
            transition: all 0.25s;
        }
        .mode-toggle button.active {
            background: var(--board-red); color: white;
            box-shadow: 0 3px 10px rgba(211,47,47,0.35);
        }

        /* --- ×ª×¤×¨×™×˜ ×œ×•×— --- */
        #board-setup { display: block; }
        /* --- ×ª×¤×¨×™×˜ ×©×—×§×Ÿ --- */
        #player-setup { display: none; }

        .setup-label {
            display: block; text-align: right;
            margin-bottom: 6px; color: #444; font-size: 0.95rem;
            font-weight: 600;
        }
        select {
            padding: 12px; font-size: 1.1rem; width: 100%;
            border-radius: 12px; border: 1px solid #ccc; background: #fafafa;
            margin-bottom: 10px;
        }

        /* --- ×¨×©×™××ª ×××’×¨×™× --- */
        .pack-list {
            display: flex; flex-direction: column; gap: 8px;
            margin-bottom: 12px;
            max-height: 240px; overflow-y: auto;
            padding-right: 4px; padding-left: 2px;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #d32f2f #f0f0f0;
        }
        .pack-list::-webkit-scrollbar { width: 6px; }
        .pack-list::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 3px; }
        .pack-list::-webkit-scrollbar-thumb { background: #d32f2f; border-radius: 3px; }
        .pack-item {
            display: flex; align-items: center; gap: 10px;
            background: #fafafa; border: 1.5px solid #e0e0e0;
            border-radius: 12px; padding: 10px 14px; cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            text-align: right;
        }
        .pack-item.selected {
            border-color: var(--board-red);
            background: #fff5f5;
        }
        .pack-item input[type="checkbox"] {
            accent-color: var(--board-red);
            width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;
            margin: 0;
        }
        .pack-item span { flex: 1; font-size: 1rem; color: #333; }
        .loading-packs { color: #aaa; font-size: 0.9rem; text-align: center; padding: 12px 0; }

        .upload-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 10px; font-size: 0.95rem;
            background: white; color: #555; border: 2px dashed #ccc;
            border-radius: 12px; cursor: pointer; margin-bottom: 10px;
            transition: border-color 0.2s, background 0.2s;
        }
        .upload-btn:hover { border-color: #999; background: #fafafa; }
        .upload-status {
            font-size: 0.85rem; color: #2e7d32; min-height: 1.2em;
            margin-bottom: 6px;
        }
        #file-upload-input { display: none; }

        /* --- ×›×¤×ª×•×¨×™× --- */
        .btn-start {
            background: var(--board-red); color: white; border: none;
            padding: 12px 40px; font-size: 1.3rem; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(211,47,47,0.3);
            transition: transform 0.2s, opacity 0.2s;
            margin-top: 10px; width: 100%;
        }
        .btn-start:active { transform: scale(0.95); }
        .btn-start:disabled { opacity: 0.4; cursor: default; }

        .btn-secondary {
            background: white; color: #555; border: 2px solid #ddd;
            padding: 10px 30px; font-size: 1.1rem; border-radius: 50px;
            cursor: pointer; margin-top: 10px; width: 100%;
            transition: background 0.2s;
        }
        .btn-secondary:hover { background: #f9f9f9; color: black; border-color: #ccc; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ××¡×š ×œ×•×—
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #game-layout { display: none; flex-direction: column; height: 100%; width: 100%; }

        header {
            height: 60px; background: white;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
            flex-shrink: 0;
        }
        .header-group { display: flex; align-items: center; gap: 8px; }
        .turn-display {
            font-weight: bold; color: #333;
            display: flex; align-items: center; gap: 8px;
            background: #f5f5f5; padding: 5px 15px; border-radius: 20px;
            font-size: 0.95rem;
        }
        .turn-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }
        .btn-icon {
            background: none; border: 1px solid #ddd;
            border-radius: 50%; width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.2rem; color: #555;
            transition: background 0.2s;
        }
        .btn-icon:hover { background: #f0f0f0; color: #000; }

        .timer-container {
            display: flex; align-items: center; gap: 5px; cursor: pointer;
            padding: 5px 10px; border-radius: 10px; transition: background 0.2s;
        }
        .timer-container:active { background: #eee; }
        .spinning { animation: spin 2s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ×œ×•×— */
        #board-container {
            flex: 1; position: relative;
            background-color: var(--board-red);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        #board {
            position: relative;
            width: 95vw; height: 85vh;
            background: radial-gradient(circle at center, #ef5350 0%, #b71c1c 100%);
            border-radius: 40px;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.4);
        }
        .center-image {
            position: absolute; top: 50%; left: 55%;
            transform: translate(-50%, -50%);
            width: 28%; height: 25%;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none; z-index: 1;
        }
        .center-image img { max-width: 100%; max-height: 100%; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
        .fallback-text {
            font-family: 'Arial Black', sans-serif; font-size: 5vh;
            color: rgba(255,255,255,0.15); letter-spacing: 5px;
        }
        .step {
            position: absolute;
            width: 9vh; height: 9vh;
            background: var(--step-bg);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: 800; color: #444; font-size: 2.5vh;
            box-shadow: 0 0.6vh 0 #ccc, 0 1vh 2vh rgba(0,0,0,0.3);
            cursor: pointer; z-index: 10;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
        }
        .step:active { transform: translate(-50%, -45%); box-shadow: 0 0.3vh 0 #ccc; }
        .step-red {
            background: #ff5252; color: white; border: 0.3vh solid white;
            box-shadow: 0 0.6vh 0 #b71c1c, 0 1vh 2vh rgba(0,0,0,0.3);
        }
        .step-start, .step-end {
            width: 10vh; height: 10vh;
            font-size: 0; z-index: 15;
            background: white;
            border: 0.5vh solid #ffd700;
        }
        .step-start svg, .step-end svg { width: 50%; height: 50%; fill: #fbc02d; }
        .step-end { border-color: #333; }
        .step-end svg { fill: #333; }
        .player-token {
            position: absolute;
            width: 4.5vh; height: 4.5vh;
            border-radius: 50%; z-index: 50;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            border: 0.3vh solid white;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            transform: translate(-50%, -50%);
        }
        .p-0 { background: radial-gradient(circle at 30% 30%, #fff59d, #fbc02d); }
        .p-1 { background: radial-gradient(circle at 30% 30%, #90caf9, #1565c0); }
        .p-2 { background: radial-gradient(circle at 30% 30%, #fafafa, #9e9e9e); }
        .p-3 { background: radial-gradient(circle at 30% 30%, #a5d6a7, #2e7d32); }
        .p-4 { background: radial-gradient(circle at 30% 30%, #ef9a9a, #c62828); }
        .p-5 { background: radial-gradient(circle at 30% 30%, #bdbdbd, #212121); }

        @media (max-aspect-ratio: 1/1) {
            #board { width: 95vw; height: auto; aspect-ratio: 1/1; }
            .step { width: 11vw; height: 11vw; font-size: 4vw; box-shadow: 0 1vw 0 #ccc; }
            .step:active { transform: translate(-50%, -45%); box-shadow: 0 0.5vw 0 #ccc; }
            .step-start, .step-end { width: 14vw; height: 14vw; }
            .player-token { width: 7vw; height: 7vw; border-width: 0.5vw; }
            .center-image { width: 32%; }
            .fallback-text { font-size: 8vw; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ××¡×š ×©×—×§×Ÿ
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #player-screen {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #ef5350 0%, #b71c1c 100%);
            z-index: 1500;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ×›×¤×ª×•×¨ ×—×–×¨×” */
        .player-back-btn {
            position: absolute; top: 18px; right: 18px;
            background: rgba(255,255,255,0.2); border: none;
            width: 42px; height: 42px; border-radius: 50%;
            font-size: 1.3rem; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .player-back-btn:hover { background: rgba(255,255,255,0.35); }

        /* counter */
        .card-counter {
            position: absolute; top: 22px; left: 18px;
            color: rgba(255,255,255,0.75); font-size: 0.9rem; font-weight: 600;
        }

        /* ×¢×¨×™××ª ×§×œ×¤×™× */
        .deck-area {
            position: relative;
            width: min(340px, 88vw);
            height: min(420px, 72vh);
            display: flex; align-items: center; justify-content: center;
        }

        /* ×§×œ×¤×™× ×‘×ª×¤××•×¨×” */
        .deck-ghost {
            position: absolute;
            width: 100%; height: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        .deck-ghost:nth-child(1) { transform: rotate(-4deg) translateY(8px); opacity: 0.5; }
        .deck-ghost:nth-child(2) { transform: rotate(2.5deg) translateY(4px); opacity: 0.7; }
        .deck-ghost:nth-child(3) { transform: rotate(-1deg) translateY(1px); opacity: 0.9; }

        /* --- ×›×¨×˜×™×¡ ×¢× flip --- */
        .card-3d-wrapper {
            position: absolute;
            width: 100%; height: 100%;
            perspective: 900px;
            z-index: 10;
        }
        .card-inner {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.65s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .card-inner.flipped { transform: rotateY(180deg); }

        .card-face, .card-back {
            position: absolute; inset: 0;
            border-radius: 20px;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            box-shadow: 0 12px 40px rgba(0,0,0,0.35);
        }

        /* --- ×’×‘ ×”×§×œ×£ --- */
        .card-back {
            background: var(--board-red);
            display: flex; align-items: center; justify-content: center;
            border: 4px solid rgba(255,255,255,0.25);
            overflow: hidden;
        }
        .card-back-inner {
            text-align: center; color: rgba(255,255,255,0.9);
        }
        .card-back-logo {
            font-size: 3.5rem; font-weight: 900; letter-spacing: 6px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-family: 'Arial Black', sans-serif;
        }
        .card-back-pattern {
            width: 100%; height: 100%; position: absolute;
            top: 0; left: 0;
            background-image: repeating-linear-gradient(
                45deg,
                rgba(255,255,255,0.04) 0px,
                rgba(255,255,255,0.04) 2px,
                transparent 2px,
                transparent 12px
            );
            pointer-events: none;
        }

        /* --- ×¤× ×™× ×”×§×œ×£ --- */
        .card-face {
            background: #fff;
            transform: rotateY(180deg);
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .card-header {
            background: var(--board-red);
            color: white;
            padding: 10px 16px;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .card-header-title {
            font-size: 1.3rem; font-weight: 900; letter-spacing: 4px;
            font-family: 'Arial Black', sans-serif;
        }
        .card-header-num {
            font-size: 0.85rem; opacity: 0.85; font-weight: 600;
        }
        .card-concepts {
            flex: 1;
            display: flex; flex-direction: column;
            padding: 6px 0;
        }
        .concept-row {
            flex: 1;
            display: flex; align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #f0f0f0;
            gap: 12px;
            direction: rtl;
        }
        .concept-row:last-child { border-bottom: none; }
        .concept-row:nth-child(odd) { background: #fafafa; }
        .concept-num {
            font-size: 0.75rem; font-weight: 800;
            color: var(--board-red);
            width: 18px; text-align: center; flex-shrink: 0;
        }
        .concept-text {
            font-size: clamp(0.95rem, 3.5vw, 1.2rem);
            font-weight: 600; color: #222;
        }

        /* ×”×•×¨××” ×ª×—×ª×™×ª */
        .player-hint {
            color: rgba(255,255,255,0.7); font-size: 0.9rem;
            margin-top: 18px; text-align: center;
        }

        /* ×›×¤×ª×•×¨ ×”×ª×—×œ×” */
        .btn-flip-start {
            margin-top: 22px;
            background: white; color: var(--board-red);
            border: none; border-radius: 50px;
            padding: 14px 44px; font-size: 1.2rem; font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-flip-start:active { transform: scale(0.95); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ××•×“××œ×™×
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
            z-index: 3000;
            justify-content: center; align-items: center;
        }
        .modal-card {
            background: white; padding: 30px; border-radius: 20px;
            text-align: center; width: 90%; max-width: 500px;
            animation: popIn 0.3s ease-out; position: relative;
        }
        .close-btn {
            position: absolute; top: 15px; left: 15px;
            background: #eee; border: none; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; font-weight: bold;
        }
        .instruction-list { text-align: right; padding-right: 20px; line-height: 1.6; color: #444; }
        .instruction-list li { margin-bottom: 8px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ×”×ª×¨××ª ×¡×™×•× ×˜×™×™××¨
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #timer-alert {
            display: none;
            position: fixed; inset: 0;
            background: rgba(183,28,28,0.93);
            z-index: 5000;
            justify-content: center; align-items: center;
            cursor: pointer;
            animation: alertFadeIn 0.35s ease-out;
        }
        @keyframes alertFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .timer-alert-emoji {
            font-size: 5rem; display: block; margin-bottom: 15px;
            animation: bigBounce 0.6s ease-out;
        }
        @keyframes bigBounce {
            0%  { transform: scale(0) rotate(-15deg); opacity: 0; }
            60% { transform: scale(1.3) rotate(5deg); opacity: 1; }
            80% { transform: scale(0.9) rotate(-3deg); }
            100%{ transform: scale(1) rotate(0deg); }
        }
        .timer-alert-text {
            font-size: 2.8rem; font-weight: 900; letter-spacing: 2px;
            color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.4);
            animation: shakeText 0.6s ease-out 0.2s both;
        }
        @keyframes shakeText {
            0%,100%{ transform: translateX(0); }
            15%    { transform: translateX(-12px); }
            30%    { transform: translateX(12px); }
            45%    { transform: translateX(-8px); }
            60%    { transform: translateX(8px); }
            75%    { transform: translateX(-4px); }
            88%    { transform: translateX(4px); }
        }
        .timer-alert-sub {
            font-size: 1rem; margin-top: 15px; color: rgba(255,255,255,0.8);
            animation: fadeUp 0.4s ease-out 0.5s both;
        }
        @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:0.8; transform:translateY(0); } }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           Toast
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #toast {
            position: fixed; top: 75px; left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(50,50,50,0.92); color: white;
            padding: 10px 24px; border-radius: 24px;
            font-size: 0.95rem; opacity: 0;
            transition: opacity 0.25s, transform 0.25s;
            z-index: 4000; pointer-events: none;
            white-space: nowrap; box-shadow: 0 4px 14px rgba(0,0,0,0.25);
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* â”€â”€ ×× ×™××¦×™×•×ª ×›×œ×œ×™×•×ª â”€â”€ */
        @keyframes popIn { from { transform:scale(0.8); opacity:0; } to { transform:scale(1); opacity:1; } }
        @keyframes bounce {
            0%,100% { transform: translateY(0); }
            40%     { transform: translateY(-18px); }
            70%     { transform: translateY(-8px); }
        }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ××¡×š ×¤×ª×™×—×”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setup-screen">
    <div class="setup-card">
        <h1>ALIDOS</h1>
        <p class="subtitle">××©×—×§ ×”×œ×•×— ×”×“×™×’×™×˜×œ×™</p>

        <!-- Toggle ××¦×‘ -->
        <div class="mode-toggle">
            <button id="btn-mode-board" class="active" onclick="setMode('board')">ğŸ² ×œ×•×—</button>
            <button id="btn-mode-player" onclick="setMode('player')">ğŸƒ ×©×—×§×Ÿ</button>
        </div>

        <!-- â”€â”€â”€ ×ª×¤×¨×™×˜ ×œ×•×— â”€â”€â”€ -->
        <div id="board-setup">
            <label class="setup-label">××¡×¤×¨ ×§×‘×•×¦×•×ª:</label>
            <select id="player-count">
                <option value="2">2 ×§×‘×•×¦×•×ª</option>
                <option value="3">3 ×§×‘×•×¦×•×ª</option>
                <option value="4" selected>4 ×§×‘×•×¦×•×ª</option>
                <option value="5">5 ×§×‘×•×¦×•×ª</option>
                <option value="6">6 ×§×‘×•×¦×•×ª</option>
            </select>
            <button class="btn-start" onclick="startBoardGame()">×”×ª×—×œ ××©×—×§</button>
            <button class="btn-secondary" onclick="showInstructions()">â“ ×”×•×¨××•×ª ×©×™××•×©</button>
        </div>

        <!-- â”€â”€â”€ ×ª×¤×¨×™×˜ ×©×—×§×Ÿ â”€â”€â”€ -->
        <div id="player-setup">
            <label class="setup-label">×‘×—×¨×• ×××’×¨×™ ××•×©×’×™×:</label>
            <div id="pack-list" class="pack-list">
                <div class="loading-packs">×˜×•×¢×Ÿ ×××’×¨×™×...</div>
            </div>

            <!-- ×”×¢×œ××ª ×§×•×‘×¥ -->
            <button class="upload-btn" onclick="document.getElementById('file-upload-input').click()">
                ğŸ“‚ ×”×¢×œ×• ×§×•×‘×¥ JSON ××”××—×©×‘
            </button>
            <input type="file" id="file-upload-input" accept=".json" onchange="handleFileUpload(event)">
            <div id="upload-status" class="upload-status"></div>

            <button class="btn-start" id="btn-start-player" onclick="startPlayerGame()" disabled>
                ×”×ª×—×œ ××©×—×§ ×©×—×§×Ÿ
            </button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ××¡×š ×œ×•×—
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game-layout">
    <header>
        <div class="header-group">
            <button class="btn-icon" onclick="backToMenu()">ğŸ </button>
            <button class="btn-icon" onclick="showInstructions()">â“</button>
            <button class="btn-icon" onclick="undoLastMove()">â†©ï¸</button>
        </div>
        <div class="turn-display">
            <div id="turn-dot" class="turn-dot" style="background:gold;"></div>
            <span id="turn-text">×§×‘×•×¦×” 1</span>
        </div>
        <div class="timer-container" onclick="toggleTimer()">
            <span id="timer-display" style="font-weight:bold;font-size:1.1rem;color:#333;">01:00</span>
            <span id="hourglass" style="font-size:1.4rem;">â³</span>
        </div>
    </header>

    <div id="board-container">
        <div id="board">
            <div class="center-image">
                <img src="alidos-logo.png"
                     onerror="this.style.display='none'; document.querySelector('.fallback-text').style.display='block'">
                <div class="fallback-text" style="display:none;">ALIDOS</div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ××¡×š ×©×—×§×Ÿ (×§×œ×¤×™×)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="player-screen">
    <button class="player-back-btn" onclick="backToMenu()">ğŸ </button>
    <span class="card-counter" id="card-counter"></span>

    <div class="deck-area" id="deck-area">
        <!-- ×¢×¨×™××ª ×§×œ×¤×™× ×ª×¤××•×¨×ª×™×ª -->
        <div class="deck-ghost"></div>
        <div class="deck-ghost"></div>
        <div class="deck-ghost"></div>

        <!-- ×§×œ×£ ×¢× flip -->
        <div class="card-3d-wrapper">
            <div class="card-inner" id="card-inner">

                <!-- ×’×‘ ×”×§×œ×£ -->
                <div class="card-back">
                    <div class="card-back-pattern"></div>
                    <div class="card-back-inner">
                        <div class="card-back-logo">ALIDOS</div>
                    </div>
                </div>

                <!-- ×¤× ×™× ×”×§×œ×£ -->
                <div class="card-face">
                    <div class="card-header">
                        <span class="card-header-title">ALIDOS</span>
                        <span class="card-header-num" id="card-num-display">×§×œ×£ 1</span>
                    </div>
                    <div class="card-concepts" id="card-concepts">
                        <!-- ×™××•×›×œ×¡ ×‘×§×•×“ -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ×›×¤×ª×•×¨ ×”×ª×—×œ×” / ×”×•×¨××” -->
    <button class="btn-flip-start" id="btn-flip-start" onclick="flipCurrentCard()">
        ×”×¤×•×š ×§×œ×£ â–¶
    </button>
    <p class="player-hint" id="player-hint">×œ×—×¦×• ×œ×”×¤×•×š ××ª ×”×§×œ×£ ×”×¨××©×•×Ÿ</p>
</div>

<!-- ×”×ª×¨××ª ×˜×™×™××¨ -->
<div id="timer-alert" onclick="dismissTimerAlert()">
    <div style="text-align:center;">
        <span class="timer-alert-emoji">â°</span>
        <div class="timer-alert-text">×”×–××Ÿ × ×’××¨!</div>
        <div class="timer-alert-sub">×œ×—×¦×• ×‘×›×œ ××§×•× ×œ×”××©×š</div>
    </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- ××•×“××œ ×”×•×¨××•×ª -->
<div id="instructions-modal" class="modal-overlay">
    <div class="modal-card">
        <button class="close-btn" onclick="closeInstructions()">âœ•</button>
        <h2 style="color:var(--btn-blue);">××™×š ××©×ª××©×™×?</h2>
        <ul class="instruction-list">
            <li><strong>××¦×‘ ×œ×•×—:</strong> ×‘×—×¨×• ××¡×¤×¨ ×§×‘×•×¦×•×ª ×•×œ×—×¦×• ×”×ª×—×œ.</li>
            <li><strong>×ª×–×•×–×”:</strong> ×œ×—×¦×• ×¢×œ ×”×¢×™×’×•×œ ×©××œ×™×• ×”×§×‘×•×¦×” ××’×™×¢×”.</li>
            <li><strong>×˜×™×™××¨:</strong> ×œ×—×¦×• ×¢×œ ×©×¢×•×Ÿ ×”×—×•×œ ×œ×”×¤×¢×œ×”/×¢×¦×™×¨×”.</li>
            <li><strong>×‘×™×˜×•×œ:</strong> ×œ×—×¦×• â†©ï¸ ×œ×‘×™×˜×•×œ ×”××”×œ×š ×”××—×¨×•×Ÿ.</li>
            <li><strong>××¦×‘ ×©×—×§×Ÿ:</strong> ×‘×—×¨×• ×××’×¨×™ ××•×©×’×™×, ×œ×—×¦×• "×”×¤×•×š ×§×œ×£" ×œ×—×©×™×¤×ª 8 ××•×©×’×™×.</li>
        </ul>
        <p>×¤×ª×—×• ××—×©×‘ ×›×œ×•×— ×•××—×©×‘ × ×•×¡×£ ××• ××›×©×™×¨ × ×™×™×“ ×œ×©×—×§×Ÿ ×”××’×“×™×¨, ×•×”×ª×—×™×œ×• ×œ×©×—×§!</p>
        <button class="btn-start" style="padding:10px 30px;font-size:1rem;" onclick="closeInstructions()">×”×‘× ×ª×™!</button>
    </div>
</div>

<!-- ××•×“××œ × ×™×¦×—×•×Ÿ -->
<div id="victory-modal" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size:4rem;margin-bottom:10px;animation:bounce 1s infinite;">ğŸ†</div>
        <h2 id="winner-name" style="margin-bottom:10px;">×§×‘×•×¦×” X × ×™×¦×—×”!</h2>
        <p>×›×œ ×”×›×‘×•×“! ×¡×™×™××ª× ××ª ×”××¡×œ×•×œ.</p>
        <button class="btn-start" style="padding:10px 30px;margin-top:20px;" onclick="closeVictory()">×¡×’×•×¨ ×•×”××©×š</button>
        <br>
        <button class="btn-secondary" style="margin-top:10px;border:none;" onclick="backToMenu()">××©×—×§ ×—×“×©</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JavaScript
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // BOARD_CONFIG
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const BOARD_CONFIG = {
        MARGIN: 10,
        RING_GAP: 17,
        NUM_RINGS: 2,
        TOTAL_STEPS: 40,
        RED_STEP_INTERVAL: 8,
        END_X: 33,
        END_Y: 50,
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // FALLBACK â€” ×××’×¨×™ ××•×©×’×™× ××•×˜××¢×™× (×›×©××™×Ÿ ×©×¨×ª)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FALLBACK_PACKS = {
        'general_he.json': ['×›×œ×‘','×—×ª×•×œ','×‘×™×ª','×¢×¥','××›×•× ×™×ª','×©××©','×™×¨×—','×›×•×›×‘','×™×','×”×¨','× ×”×¨','×’×©×','×©×œ×’','×¢× ×Ÿ','×¨×•×—','××©','××™×','××“××”','×¤×¨×—','×¤×¨×™','×™×¨×§','×œ×—×','×—×œ×‘','×‘×™×¦×”','×¡×¤×¨','×¢×™×¤×¨×•×Ÿ','×©×•×œ×—×Ÿ','×›×™×¡×','××™×˜×”','×“×œ×ª','×—×œ×•×Ÿ','××¤×ª×—','×©×¢×•×Ÿ','×˜×œ×¤×•×Ÿ','××—×©×‘','×ª×™×§','× ×¢×œ','×›×•×‘×¢','×—×•×œ×¦×”','××›× ×¡×™×™×','×›×¡×£','×–×”×‘','××‘×Ÿ','×’×©×¨','×›×‘×™×©','×¨×›×‘×ª','××•×˜×•×‘×•×¡','××˜×•×¡','×¡×¤×™× ×”','××•×¤× ×™×™×','×× ×•×¨×”','×›×•×¡','×¦×œ×—×ª','×›×£','××–×œ×’','×¡×›×™×Ÿ','×¡×™×¨','×ª× ×•×¨','××§×¨×¨','××¨××”','×¡×‘×•×Ÿ','××’×‘×ª','×¨×•×¤×','××•×¨×”','×©×•×˜×¨','×©×£','×–××¨','×©×—×§×Ÿ','×ª×¨× ×’×•×œ×ª','×¤×¨×”','×¡×•×¡','×›×‘×©','×¢×›×‘×¨','×¦×™×¤×•×¨','×“×’','× ×—×©','×¤×™×œ','××¨×™','×§×•×£','×“×•×‘×™','×–××‘','×©×•×¢×œ','××¨× ×‘','×ª× ×™×Ÿ','×¦×‘','×“×‘×•×¨×”','×¤×¨×¤×¨'],
        'sports_he.json': ['×›×“×•×¨×’×œ','×›×“×•×¨×¡×œ','×›×“×•×¨×¢×£','×˜× ×™×¡','×©×—×™×™×”','××ª×œ×˜×™×§×”','×”×ª×¢××œ×•×ª','××’×¨×•×£','×¨×›×™×‘×”','×’×œ×™×©×”','×¡×§×™','×”×•×§×™','×¨×™×¦×”','××¨×ª×•×Ÿ','××•×œ×™××¤×™××“×”','×›×“×•×¨ ×™×“','×¨×•×’×‘×™','×©×•×¢×¨','×§×¤×˜×Ÿ','×©×•×¤×˜','×¤× ×“×œ','×§×¨× ×¨','×‘×¢×™×˜×”','×–×¨×™×§×”','×—×¡×™××”','××¡×™×¨×”','× ×™×¦×—×•×Ÿ','×ª×™×§×•','×”×¤×¡×“','×œ×™×’×”','×’×‘×™×¢','××œ×™×¤×•×ª','××“×œ×™×”','×¨×©×ª','××’×¨×©','××¦×˜×“×™×•×Ÿ','×’××¨','×˜×•×¨× ×™×¨','×¡×¤×¨×™× ×˜','××¡×œ×•×œ','×‘×¨×™×›×”','×¨××”','×—×’×•×¨×”','×¡×¤×•×¨×˜××™','××™××•×Ÿ','××××Ÿ'],
        'food_he.json': ['×¤×™×¦×”','×”××‘×•×¨×’×¨','×¡×•×©×™','×¤×¡×˜×”','×¡×œ×˜','××¨×§','×©× ×™×¦×œ','×©×§×©×•×§×”','×—×•××•×¡','×¤×œ××¤×œ','×©×•×•××¨××”','×§×‘×‘','×¡×˜×™×™×§','×¢×•×£ ×‘×¦×œ×—×ª','×“×’ ××˜×•×’×Ÿ','×’×‘×™× ×” ×¦×”×•×‘×”','×™×•×’×•×¨×˜','×’×œ×™×“×”','×¢×•×’×ª ×©×•×§×•×œ×“','×¢×•×’×™×•×ª','×œ×—×','×¤×™×ª×”','×‘×’×˜','×§×¨×•××¡×•×Ÿ','×¡×‘×™×—','×˜××§×•','×•×•×¤×œ','×¤× ×§×™×™×§','×—×‘×™×ª×”','×©×•×§×•','×§×¤×”','×ª×”','××™×¥','×©××Ÿ ×–×™×ª','×—×•××¥','×œ×™××•×Ÿ','×©×•×','×‘×¦×œ','×¢×’×‘× ×™×™×”','××œ×¤×¤×•×Ÿ','×’×–×¨','×ª×¤×•×— ××“××”','×‘×˜×˜×”','×‘×¨×•×§×•×œ×™','×ª×™×¨×¡','××¤×•× ×”','×©×¢×•×¢×™×ª','×¢×“×©×™×','××•×¨×–','×©×•×§×•×œ×“','×•× ×™×œ','×§×™× ××•×Ÿ','×“×‘×©','×¨×™×‘×”'],
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ××¦×‘ UI
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentMode = 'board'; // 'board' | 'player'

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ××¦×‘ ×œ×•×—
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const colors = [
        { name: '×¦×”×•×‘', hex: '#fbc02d', class: 'p-0' },
        { name: '×›×—×•×œ', hex: '#1565c0', class: 'p-1' },
        { name: '×œ×‘×Ÿ',  hex: '#e0e0e0', class: 'p-2' },
        { name: '×™×¨×•×§', hex: '#2e7d32', class: 'p-3' },
        { name: '××“×•×', hex: '#c62828', class: 'p-4' },
        { name: '×©×—×•×¨', hex: '#212121', class: 'p-5' },
    ];
    let players = [], currentPlayerIndex = 0, coords = [], historyStack = [];
    let timerInterval, timeLeft = 60, isTimerRunning = false;
    let toastTimeout = null;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ××¦×‘ ×©×—×§×Ÿ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let availablePacks   = {};  // { filename: displayName }
    let selectedPacks    = new Set();
    selectedPacks.add('bava_metzia.json');
    let uploadedConcepts = [];  // ××•×©×’×™× ×©×”×•×¢×œ×• ×™×“× ×™×ª

    let conceptDeck = [];     // ×›×œ ×”××•×©×’×™× ××××’×¨×™× ×©× ×‘×—×¨×•, ××¢×•×¨×‘×‘×™×
    let deckPointer = 0;      // ××¦×‘×™×¢ ×œ××™×¤×” ×× ×—× ×• ×‘DeÚ©
    let cardNumber  = 0;      // ××¡×¤×¨ ×§×œ×£ × ×•×›×—×™ (×œ×ª×¦×•×’×”)
    let cardFlipped = false;  // ×”×× ×”×§×œ×£ ×”× ×•×›×—×™ ×›×‘×¨ ×”×•×¤× ×”?

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ××ª×—×•×œ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('DOMContentLoaded', loadPackList);

    async function loadPackList() {
        let packs;
        try {
            const res = await fetch('concept_packs.json');
            if (!res.ok) throw new Error('not ok');
            packs = await res.json();
        } catch {
            // fallback â€” ×”×’×“×¨ ×œ×¤×™ FALLBACK_PACKS
            packs = {
                'general_he.json': '××™×œ×™× ×›×œ×œ×™×•×ª',
                'sports_he.json': '×¡×¤×•×¨×˜',
                'food_he.json': '××•×›×œ ×•×‘×™×©×•×œ',
            };
        }
        availablePacks = packs;
        renderPackList();
    }

    function renderPackList() {
        const container = document.getElementById('pack-list');
        container.innerHTML = '';
        Object.entries(availablePacks).forEach(([filename, displayName]) => {
            const item = document.createElement('div');
            item.className = 'pack-item' + (selectedPacks.has(filename) ? ' selected' : '');
            item.innerHTML = `
                <input type="checkbox" id="chk-${filename}"
                    ${selectedPacks.has(filename) ? 'checked' : ''}
                    onchange="togglePack('${filename}', this.checked)">
                <label for="chk-${filename}" style="flex:1;cursor:pointer;text-align:right;">
                    ${displayName}
                </label>`;
            item.onclick = (e) => {
                if (e.target.tagName !== 'INPUT') {
                    const chk = item.querySelector('input');
                    chk.checked = !chk.checked;
                    togglePack(filename, chk.checked);
                }
            };
            container.appendChild(item);
        });
        updateStartPlayerBtn();
    }

    function togglePack(filename, checked) {
        if (checked) selectedPacks.add(filename);
        else selectedPacks.delete(filename);
        // ×¢×“×›×Ÿ ×¢×™×¦×•×‘
        const item = document.querySelector(`#chk-${filename}`)?.closest('.pack-item');
        if (item) item.classList.toggle('selected', checked);
        updateStartPlayerBtn();
    }

    function updateStartPlayerBtn() {
        const btn = document.getElementById('btn-start-player');
        btn.disabled = selectedPacks.size === 0 && uploadedConcepts.length === 0;
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data)) throw new Error('×œ× ××¢×¨×š');
                uploadedConcepts = data.map(String);
                document.getElementById('upload-status').textContent =
                    `âœ“ × ×˜×¢×Ÿ: "${file.name}" (${uploadedConcepts.length} ××•×©×’×™×)`;
                updateStartPlayerBtn();
            } catch {
                document.getElementById('upload-status').textContent = 'âŒ ×©×’×™××”: ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ';
            }
        };
        reader.readAsText(file);
        // ××¤×¡ ×›×“×™ ×œ××¤×©×¨ ×”×¢×œ××” ×©×•×‘
        event.target.value = '';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // × ×™×”×•×œ ××¦×‘ UI
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('board-setup').style.display  = mode === 'board'  ? 'block' : 'none';
        document.getElementById('player-setup').style.display = mode === 'player' ? 'block' : 'none';
        document.getElementById('btn-mode-board').classList.toggle('active',  mode === 'board');
        document.getElementById('btn-mode-player').classList.toggle('active', mode === 'player');
    }

    function backToMenu() {
        resetTimer();
        document.getElementById('game-layout').style.display   = 'none';
        document.getElementById('player-screen').style.display = 'none';
        const ss = document.getElementById('setup-screen');
        ss.style.opacity = '0';
        ss.style.display = 'flex';
        setTimeout(() => ss.style.opacity = '1', 10);
        // ×¡×’×•×¨ ××•×“××œ×™× ×¤×ª×•×—×™×
        closeVictory();
        closeInstructions();
    }

    function showInstructions() { document.getElementById('instructions-modal').style.display = 'flex'; }
    function closeInstructions() { document.getElementById('instructions-modal').style.display = 'none'; }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ××¦×‘ ×œ×•×— â€” ×”×ª×—×œ×”
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startBoardGame() {
        const count = parseInt(document.getElementById('player-count').value);
        players = [];
        historyStack = [];
        for (let i = 0; i < count; i++) players.push({ id: i, pos: 0 });
        currentPlayerIndex = 0;

        document.getElementById('setup-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-layout').style.display = 'flex';
            buildBoard();
            renderPlayers();
            updateUI();
            resetTimer();
        }, 400);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ××¦×‘ ×©×—×§×Ÿ â€” ×”×ª×—×œ×”
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function startPlayerGame() {
        // ××™×¡×•×£ ××•×©×’×™×
        let all = [...uploadedConcepts];

        for (const filename of selectedPacks) {
            let concepts = null;
            try {
                const res = await fetch(filename);
                if (!res.ok) throw new Error('not ok');
                concepts = await res.json();
            } catch {
                concepts = FALLBACK_PACKS[filename] || [];
            }
            all = all.concat(concepts);
        }

        if (all.length < 8) {
            showToast('âŒ ××™×Ÿ ××¡×¤×™×§ ××•×©×’×™× (×“×¨×•×© ××™× ×™××•× 8)');
            return;
        }

        // ×¢×¨×‘×•×‘
        conceptDeck = shuffle([...new Set(all)]); // ×”×¡×¨ ×›×¤×™×œ×•×™×•×ª ×•×¢×¨×‘×‘
        deckPointer = 0;
        cardNumber  = 0;
        cardFlipped = false;

        // ××¢×‘×¨ ×œ××¡×š ×©×—×§×Ÿ
        document.getElementById('setup-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('player-screen').style.display = 'flex';
            resetCard();
        }, 400);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ×œ×•×’×™×§×ª ×§×œ×¤×™×
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function resetCard() {
        const inner = document.getElementById('card-inner');
        inner.classList.remove('flipped');
        cardFlipped = false;

        document.getElementById('btn-flip-start').style.display = 'inline-block';
        document.getElementById('player-hint').textContent = '×œ×—×¦×• ×œ×”×¤×•×š ××ª ×”×§×œ×£';

        // ×× ×™×¢×ª ×§×œ×™×§ ×¢×œ ×§×œ×£ ×œ× ××•×¤× ×”
        inner.style.pointerEvents = 'none';

        updateCardCounter();
    }

    function flipCurrentCard() {
        if (cardFlipped) return;

        const concepts = getNextConcepts(8);
        cardNumber++;
        populateCardFace(concepts, cardNumber);
        updateCardCounter();

        const inner = document.getElementById('card-inner');
        inner.style.pointerEvents = 'auto';
        requestAnimationFrame(() => inner.classList.add('flipped'));
        cardFlipped = true;

        document.getElementById('btn-flip-start').style.display = 'none';
        document.getElementById('player-hint').textContent = '×œ×—×¦×• ×¢×œ ×”×§×œ×£ ×œ×§×œ×£ ×”×‘×';

        inner.onclick = advanceCard;
    }

    function advanceCard() {
        const inner = document.getElementById('card-inner');
        inner.onclick = null;
        inner.style.pointerEvents = 'none';

        // ×”×¤× ×” ×—×–×¨×” (×× ×™××¦×™×” ×§×¦×¨×”)
        inner.classList.remove('flipped');
        cardFlipped = false;

        // ××—×¨×™ ×©×”×× ×™××¦×™×” ×—×–×¨×” â€” ×˜×¢×Ÿ ×§×œ×£ ×—×“×© ××™×“ ×œ×œ× ×›×¤×ª×•×¨
        setTimeout(() => {
            const concepts = getNextConcepts(8); // ×¢×¨×‘×•×‘ ××—×“×© ××•×˜×•××˜×™ ×× ×¦×¨×™×š
            cardNumber++;
            populateCardFace(concepts, cardNumber);
            updateCardCounter();

            // ×”×¤×•×š ××™×“ ×œ×¤× ×™×
            requestAnimationFrame(() => {
                inner.classList.add('flipped');
                cardFlipped = true;
                inner.style.pointerEvents = 'auto';
                inner.onclick = advanceCard;
                document.getElementById('player-hint').textContent = '×œ×—×¦×• ×¢×œ ×”×§×œ×£ ×œ×§×œ×£ ×”×‘×';
            });
        }, 380); // ×××ª×™×Ÿ ×œ×¡×™×•× ×× ×™××¦×™×™×ª ×”-flip ×—×–×¨×” (0.35s ×‘CSS)
    }

    function getNextConcepts(n) {
        // ×× × ×•×ª×¨×• ×¤×—×•×ª ×-n ××•×©×’×™× â€” ×¢×¨×‘×‘ ××—×“×© ×œ×¤× ×™ ×”×—×™×œ×•×¥
        if (conceptDeck.length - deckPointer < n) {
            reshuffleDeck(); // ×××¤×¡ deckPointer=0 + ×¢×¨×‘×•×‘
        }
        const slice = conceptDeck.slice(deckPointer, deckPointer + n);
        deckPointer += slice.length;
        return slice;
    }

    function reshuffleDeck() {
        conceptDeck = shuffle(conceptDeck);
        deckPointer = 0;
        showToast('ğŸ”„ ×”×××’×¨ ×”×¡×ª×™×™× â€” ××ª×—×™×œ ×¡×™×‘×•×‘ ×—×“×©!');
    }

    function populateCardFace(concepts, num) {
        document.getElementById('card-num-display').textContent = `×§×œ×£ ${num}`;
        const container = document.getElementById('card-concepts');
        container.innerHTML = '';
        concepts.forEach((word, i) => {
            const row = document.createElement('div');
            row.className = 'concept-row';
            row.innerHTML = `<span class="concept-num">${i + 1}</span>
                             <span class="concept-text">${word}</span>`;
            container.appendChild(row);
        });
    }

    function updateCardCounter() {
        const remaining = conceptDeck.length - deckPointer;
        document.getElementById('card-counter').textContent =
            `${remaining} ××•×©×’×™× × ×•×ª×¨×•`;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ×‘× ×™×™×ª ×”×œ×•×—
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function generateSpiralWaypoints(cfg) {
        const { MARGIN, RING_GAP, NUM_RINGS, END_X, END_Y } = cfg;
        const wp = [];
        for (let r = 0; r < NUM_RINGS; r++) {
            const L = MARGIN + r * RING_GAP;
            const R = 100 - MARGIN - r * RING_GAP;
            const T = MARGIN + r * RING_GAP;
            const B = 100 - MARGIN - r * RING_GAP;
            if (r === 0) wp.push({ x: L, y: T });
            wp.push({ x: R, y: T });
            wp.push({ x: R, y: B });
            wp.push({ x: L, y: B });
            if (r < NUM_RINGS - 1) {
                const nextT = MARGIN + (r + 1) * RING_GAP;
                wp.push({ x: L, y: nextT });
            }
        }
        const innerL = MARGIN + (NUM_RINGS - 1) * RING_GAP;
        const innerT = MARGIN + (NUM_RINGS - 1) * RING_GAP;
        const innerB = 100 - MARGIN - (NUM_RINGS - 1) * RING_GAP;
        wp.push({ x: innerL, y: (innerT + innerB) / 2 });
        wp.push({ x: END_X, y: END_Y });
        return wp;
    }

    /**
     * generateEquidistantPoints
     * ××¨×—×§×™× ××•×§×œ×™×“×™×™× ××—×•×©×‘×™× ×‘××¨×—×‘ ×”×¤×™×§×¡×œ×™× ×”×××™×ª×™ ×©×œ ×”×œ×•×— (boardW Ã— boardH),
     * ×›×š ×©×¦×œ×¢×•×ª ××•×¤×§×™×•×ª ×•×× ×›×™×•×ª ××›×™×œ×•×ª ××¡×¤×¨ ×©×•×•×” ×©×œ ××©×‘×¦×•×ª ×‘×™×—×¡ ×œ××•×¨×›×Ÿ ×‘×¤×™×§×¡×œ×™×.
     *
     * @param {Array<{x,y}>} points  - × ×§×•×“×•×ª ×¦×™×•×Ÿ (×‘-%)
     * @param {number}       steps   - ××¡×¤×¨ × ×§×•×“×•×ª ×ª×•×¦××”
     * @param {number}       boardW  - ×¨×•×—×‘ ×”×œ×•×— ×‘×¤×™×§×¡×œ×™×
     * @param {number}       boardH  - ×’×•×‘×” ×”×œ×•×— ×‘×¤×™×§×¡×œ×™×
     */
    function generateEquidistantPoints(points, steps, boardW, boardH) {
        // ×”××¨×” ×œ-px ×œ×¦×•×¨×š ×—×™×©×•×‘ ××¨×—×§×™× ×××™×ª×™×™×
        const toPx = p => ({ px: p.x / 100 * boardW, py: p.y / 100 * boardH });

        const lengths = [];
        let totalLength = 0;
        for (let i = 0; i < points.length - 1; i++) {
            const a = toPx(points[i]);
            const b = toPx(points[i + 1]);
            const dx = b.px - a.px, dy = b.py - a.py;
            const dist = Math.sqrt(dx * dx + dy * dy);
            lengths.push(dist);
            totalLength += dist;
        }

        const stepSize = totalLength / (steps - 1);
        const result = [{ x: points[0].x, y: points[0].y }];
        let accumDist = 0, seg = 0;

        for (let i = 1; i < steps; i++) {
            const target = i * stepSize;
            while (seg < lengths.length - 1 && accumDist + lengths[seg] < target) {
                accumDist += lengths[seg];
                seg++;
            }
            const ratio = (target - accumDist) / lengths[seg];
            // ××™× ×˜×¨×¤×•×œ×¦×™×” ×‘-% (××™×§×•× ×¢×œ ×”××¡×š)
            result.push({
                x: points[seg].x + (points[seg + 1].x - points[seg].x) * ratio,
                y: points[seg].y + (points[seg + 1].y - points[seg].y) * ratio,
            });
        }
        return result;
    }

    function buildBoard() {
        const board = document.getElementById('board');
        const boardW = board.clientWidth;
        const boardH = board.clientHeight;

        Array.from(board.children).forEach(c => {
            if (c.classList.contains('step') || c.classList.contains('player-token')) c.remove();
        });

        const waypoints = generateSpiralWaypoints(BOARD_CONFIG);
        coords = generateEquidistantPoints(waypoints, BOARD_CONFIG.TOTAL_STEPS, boardW, boardH);

        // ×¦×¢×“×™× ××“×•××™× â€” ×—×™×©×•×‘ ×“×™× ××™ ×œ×¤×™ interval
        const redSteps = new Set();
        for (let idx = BOARD_CONFIG.RED_STEP_INTERVAL; idx < coords.length - 1; idx += BOARD_CONFIG.RED_STEP_INTERVAL) {
            redSteps.add(idx);
        }

        let displayNum = 1;
        coords.forEach((pos, index) => {
            const el = document.createElement('div');
            el.className = 'step';
            el.style.left = pos.x + '%';
            el.style.top  = pos.y + '%';

            if (index === 0) {
                el.classList.add('step-start');
                el.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
            } else if (index === coords.length - 1) {
                el.classList.add('step-end');
                el.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20.2 2H3.8C2.8 2 2 2.8 2 3.8v1.4c0 3.2 2.2 5.9 5.2 6.6.6 2.8 2.8 5 5.5 5.6V20H9v2h6v-2h-3.7v-2.6c2.8-.6 4.9-2.8 5.5-5.6 3-.7 5.2-3.4 5.2-6.6V3.8c0-1-.8-1.8-1.8-1.8zM7 5h2v6H7V5zm10 6h-2V5h2v6z"/></svg>';
            } else {
                el.innerText = displayNum;
                if (redSteps.has(index)) el.classList.add('step-red');
                displayNum = displayNum < 8 ? displayNum + 1 : 1;
            }

            el.onclick = () => handleMove(index);
            board.appendChild(el);
        });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ××©×—×§×™×•×ª â€” ×œ×•×—
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPlayers() {
        const board = document.getElementById('board');
        players.forEach((p, idx) => {
            let token = document.getElementById(`p-token-${idx}`);
            if (!token) {
                token = document.createElement('div');
                token.id = `p-token-${idx}`;
                token.className = `player-token ${colors[idx].class}`;
                board.appendChild(token);
            }
            const pos = coords[p.pos];
            let ox = 0, oy = 0;
            const same = players.filter(pl => pl.pos === p.pos);
            if (same.length > 1) {
                const si = same.findIndex(pl => pl.id === p.id);
                const angle = (2 * Math.PI / same.length) * si;
                ox = Math.cos(angle) * 1.8;
                oy = Math.sin(angle) * 1.8;
            }
            token.style.left = (pos.x + ox) + '%';
            token.style.top  = (pos.y + oy) + '%';
        });
    }

    function handleMove(targetIndex) {
        historyStack.push({ playerIndex: currentPlayerIndex, prevPos: players[currentPlayerIndex].pos });
        players[currentPlayerIndex].pos = targetIndex;
        renderPlayers();
        if (targetIndex === coords.length - 1) {
            const w = colors[currentPlayerIndex];
            document.getElementById('winner-name').innerText = `×§×‘×•×¦×ª ${w.name} × ×™×¦×—×”!`;
            document.getElementById('winner-name').style.color = w.hex;
            document.getElementById('victory-modal').style.display = 'flex';
        }
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
        updateUI();
        resetTimer();
    }

    function undoLastMove() {
        if (!historyStack.length) { showToast('âš ï¸ ××™×Ÿ ××”×œ×š ×§×•×“× ×œ×‘×™×˜×•×œ'); return; }
        const last = historyStack.pop();
        currentPlayerIndex = last.playerIndex;
        players[currentPlayerIndex].pos = last.prevPos;
        renderPlayers();
        updateUI();
        resetTimer();
        showToast('â†©ï¸ ×”××”×œ×š ×‘×•×˜×œ');
    }

    function updateUI() {
        const c = colors[currentPlayerIndex];
        document.getElementById('turn-text').innerText = c.name;
        document.getElementById('turn-text').style.color = c.hex;
        document.getElementById('turn-dot').style.background = c.hex;
    }

    function closeVictory() { document.getElementById('victory-modal').style.display = 'none'; }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ×˜×™×™××¨
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleTimer() {
        const hIcon = document.getElementById('hourglass');
        const tDisp = document.getElementById('timer-display');
        if (isTimerRunning) {
            clearInterval(timerInterval);
            isTimerRunning = false;
            hIcon.classList.remove('spinning');
            tDisp.style.opacity = '0.5';
        } else {
            isTimerRunning = true;
            hIcon.classList.add('spinning');
            tDisp.style.opacity = '1';
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    hIcon.classList.remove('spinning');
                    showTimerAlert();
                }
            }, 1000);
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        timeLeft = 60;
        document.getElementById('hourglass').classList.remove('spinning');
        updateTimerDisplay();
        document.getElementById('timer-display').style.opacity = '1';
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        document.getElementById('timer-display').innerText = `0${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function showTimerAlert() {
        const el = document.getElementById('timer-alert');
        el.style.animation = 'alertFadeIn 0.35s ease-out';
        el.style.display = 'flex';
    }

    function dismissTimerAlert() {
        const el = document.getElementById('timer-alert');
        el.style.transition = 'opacity 0.3s';
        el.style.opacity = '0';
        setTimeout(() => {
            el.style.display = 'none';
            el.style.opacity = '';
            el.style.transition = '';
            resetTimer(); // â† ××™×¤×•×¡ ×œ-01:00 ×œ××—×¨ ×¡×’×™×¨×ª ×”-overlay
        }, 300);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Toast
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => t.classList.remove('show'), 2500);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ×›×œ×™ ×¢×–×¨
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }
</script>
</body>
</html>
